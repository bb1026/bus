<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬äº¤ç«™æŸ¥è¯¢ä¸æ”¶è—</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />
<style>
body { 
    font-family: Arial, sans-serif; 
    margin:0; 
    padding:10px; 
    background:#f5f5f5; 
}
h2 { 
    text-align:center; 
    margin-bottom:10px; 
}
.controls { 
    display:flex; 
    flex-wrap:wrap; 
    gap:10px; 
    justify-content:center; 
    margin-bottom:10px; 
}
input, button { 
    padding:6px 10px; 
    font-size:14px; 
    border-radius:5px; 
    border:1px solid #ccc; 
}
button { 
    cursor:pointer; 
    background:#007bff; 
    color:#fff; 
    border:none; 
    display:flex; 
    align-items:center; 
    gap:5px; 
}
button:hover { 
    background:#0056b3; 
}
.busstop-container { 
    display:flex; 
    flex-direction:column; 
}
.busstop-card { 
    background:#fff; 
    padding:15px; 
    border-radius:8px; 
    margin-bottom:10px; 
    box-shadow:0 2px 4px rgba(0,0,0,0.1); 
}
.busstop-header { 
    cursor:pointer; 
}
.busstop-header h3 { 
    margin:0; 
    font-size:18px; 
}
.busstop-header p { 
    margin:2px 0; 
    color:#666; 
    font-size:14px; 
}
.separator { 
    border-top:1px solid #ccc; 
    margin:8px 0; 
    display:none; 
}
.bus-list { 
    display:none; 
    flex-direction:column; 
}
.bus-list.show { 
    display:flex; 
}
.bus-list.show + .separator { 
    display:block; 
}
.bus-item { 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    padding:8px; 
    background:#f9f9f9; 
    border-top:1px solid #ddd; 
    cursor:pointer; 
}
.star { 
    cursor:pointer; 
    font-size:26px; 
    color:#ffcc00; 
}
.star.unfilled { 
    color:#ccc; 
}
.favorite-section { 
    margin-bottom:15px; 
}
.nearby-section { 
    margin-bottom:15px; 
}
.modal { 
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center; 
}
.modal-content { 
    background:#fff; 
    padding:20px; 
    border-radius:10px; 
    width:90%; 
    max-width:500px; 
    max-height:90%; 
    overflow:auto; 
}
.modal-close { 
    float:right; 
    cursor:pointer; 
    font-size:18px; 
}
.tab { 
    display:flex; 
    justify-content:center; 
    gap:10px; 
    margin-top:10px; 
}
.tab button { 
    flex:1; 
    text-align:center; 
}
.tab-content { 
    display:none; 
    margin-top:10px; 
}
.tab-content.active { 
    display:block; 
}
.route-map { 
    margin-top:10px; 
    font-size:15px; 
}
.route-stop { 
    display:flex; 
    align-items:flex-start; 
    margin-bottom:5px; 
}
.route-line { 
    width:20px; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
}
.route-circle { 
    width:10px; 
    height:10px; 
    border-radius:50%; 
    background:#007bff; 
}
.route-circle.current { 
    background:#ff0000; 
}
.route-connector { 
    flex:1; 
    width:2px; 
    background:#007bff; 
}
.route-text { 
    margin-left:8px; 
    flex:1; 
}
.route-refresh { 
    margin-left:10px; 
    background:transparent; 
    border:none; 
    color:#007bff; 
    cursor:pointer; 
    font-size:14px; 
}
.route-refresh:hover { 
    color:#0056b3; 
}
.route-times { 
    margin-top:5px; 
    font-size:12px; 
    color:#666; 
    padding-left:28px; 
}
.op-table { 
    border-collapse: collapse; 
    margin-top:5px; 
    font-size:14px; 
}
.op-table th, .op-table td { 
    border:1px solid #ccc; 
    padding:3px 8px; 
    text-align:center; 
}
.op-table td:first-child { 
    text-align:left; 
}
#backBtn { 
    display:none; 
    margin:10px auto; 
}
.refresh-time { 
    font-size: 12px; 
    color: #666; 
    margin-left: 10px; 
}
.search-section {
    margin-bottom:15px; 
}

<!-- éšè—æŸ¥è¯¢æŒ‰é’® -->
#searchBtn { display: none; }
</style>
</head>
<body>

<h2><i class="fas fa-bus"></i> å…¬äº¤ç«™æŸ¥è¯¢ä¸æ”¶è—</h2>

<div class="controls">
  <input type="text" id="searchInput" placeholder="è¾“å…¥å·´å£«ç«™å·æˆ–å·´å£«å·">
  <button id="searchBtn"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
  <button id="refreshBtn"><i class="fas fa-location-crosshairs"></i> åˆ·æ–°ä½ç½®</button>
</div>

<div class="favorite-section" id="favoriteSection">
  <h3>æˆ‘çš„æ”¶è—</h3>
</div>

<div class="nearby-section" id="nearbySection">
  <h3>é™„è¿‘å·´å£«</h3>
</div>

<div class="search-section" id="searchSection" style="display:none;">
  <h3>æœç´¢ç»“æœ</h3>
</div>

<div class="busstop-container" id="busstopContainer"></div>

<!-- å¼¹çª— -->
<div class="modal" id="busModal">
  <div class="modal-content">
    <span class="modal-close" id="modalClose">&times;</span>
    <h3 id="modalBusNo"></h3>
    <div class="tab" id="modalTabs"></div>
    <div id="modalTabContents"></div>
  </div>
</div>

<script>
const BUS_STOPS_URL = "https://raw.githubusercontent.com/bb1026/bus/main/json/busStops.json";
const BUS_ROUTES_URL = "https://raw.githubusercontent.com/bb1026/bus/main/json/busRoutes.json";
const BUS_SERVICES_URL = "https://raw.githubusercontent.com/bb1026/bus/main/json/busServices.json";
const BUS_ARRIVAL_API = "https://busapi.0515364.xyz/busarrival?BusStopCode=";

let busStops=[], busRoutes=[], busServices=[];
let userPosition=null;
let favoriteBuses=JSON.parse(localStorage.getItem('favoriteBuses')||'[]');
let refreshInterval = null;
let currentView = 'default'; // 'default', 'search'

function saveFavorites(){ localStorage.setItem('favoriteBuses',JSON.stringify(favoriteBuses)); }
function haversine(lat1,lon1,lat2,lon2){
  const R=6371000, toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function loadData(){
  [busStops,busRoutes,busServices]=await Promise.all([
    fetch(BUS_STOPS_URL).then(r=>r.json()),
    fetch(BUS_ROUTES_URL).then(r=>r.json()),
    fetch(BUS_SERVICES_URL).then(r=>r.json())
  ]);
}

async function getBusArrivalTimes(busStopCode) {
  try {
    const response = await fetch(`${BUS_ARRIVAL_API}${busStopCode}`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error("è·å–å®æ—¶æ•°æ®å¤±è´¥:", error);
    return null;
  }
}

function getNextBuses(busStopCode){
  // ä½¿ç”¨æ‚¨æä¾›çš„æ–¹æ³•å»é‡
  const matchedRoutes = busRoutes
    .filter(route => route.BusStopCode === busStopCode)
    .sort((a, b) => a.Direction - b.Direction || a.StopSequence - b.StopSequence);
  
  // å»é‡å¤„ç†
  const uniqueBuses = [];
  const seen = new Set();
  
  matchedRoutes.forEach(route => {
    const key = `${route.ServiceNo}-${route.Direction}`;
    if (!seen.has(key)) {
      seen.add(key);
      uniqueBuses.push(route);
    }
  });
  
  return uniqueBuses.map(b=>{
    const svc=busServices.find(s=>s.ServiceNo===b.ServiceNo&&s.Direction===b.Direction);
    const destStop=busStops.find(bs=>bs.BusStopCode===(svc?svc.DestinationCode:b.DestinationCode));
    const originStop=busStops.find(bs=>bs.BusStopCode===(svc?svc.OriginCode:b.BusStopCode));
    return {
      ServiceNo:b.ServiceNo,
      Operator:b.Operator,
      Direction:b.Direction,
      Origin:originStop?`${originStop.Description} (${originStop.BusStopCode})`:`${b.BusStopCode}`,
      Destination:destStop?`${destStop.Description} (${destStop.BusStopCode})`:`${b.DestinationCode}`,
      WD_FirstBus:b.WD_FirstBus||'--',
      WD_LastBus:b.WD_LastBus||'--',
      SAT_FirstBus:b.SAT_FirstBus||'--',
      SAT_LastBus:b.SAT_LastBus||'--',
      SUN_FirstBus:b.SUN_FirstBus||'--',
      SUN_LastBus:b.SUN_LastBus||'--'
    };
  });
}

function getNearbyBusStops(limit=20){
  if(!userPosition) return [];
  return busStops.map(bs=>{
    const dist=haversine(userPosition.lat,userPosition.lng,bs.Latitude,bs.Longitude);
    return {...bs,distance:dist};
  }).sort((a,b)=>a.distance-b.distance)
    .filter(bs => bs.distance <= 500) // åªæ˜¾ç¤º500ç±³ä»¥å†…çš„å·´å£«ç«™
    .slice(0,limit);
}

// ---------- æ”¶è—æ“ä½œ ----------
function toggleFavorite(busStopCode,bus){
  const idx=favoriteBuses.findIndex(f=>f.BusStopCode===busStopCode && f.bus.ServiceNo===bus.ServiceNo);
  if(idx>=0) favoriteBuses.splice(idx,1);
  else favoriteBuses.push({BusStopCode:busStopCode,bus});
  saveFavorites();
  renderAllSections();
}

// ---------- åªåˆ·æ–°æ—¶é—´ ----------
async function refreshTimesOnly() {
  // åˆ·æ–°æ”¶è—éƒ¨åˆ†çš„æ—¶é—´
  const favoriteCards = document.querySelectorAll('#favoriteSection .busstop-card');
  for (const card of favoriteCards) {
    const headerText = card.querySelector('.busstop-header p').textContent;
    const busStopCode = headerText.split(' ')[0];
    await updateBusTimes(card, busStopCode);
  }
  
  // åˆ·æ–°é™„è¿‘ç«™ç‚¹éƒ¨åˆ†çš„æ—¶é—´
  const nearbyCards = document.querySelectorAll('#nearbySection .busstop-card');
  for (const card of nearbyCards) {
    const headerText = card.querySelector('.busstop-header p').textContent;
    const busStopCode = headerText.split(' ')[0];
    await updateBusTimes(card, busStopCode);
  }
  
  // åˆ·æ–°æœç´¢ç»“æœéƒ¨åˆ†çš„æ—¶é—´
  const searchCards = document.querySelectorAll('#searchSection .busstop-card');
  for (const card of searchCards) {
    const headerText = card.querySelector('.busstop-header p').textContent;
    const busStopCode = headerText.split(' ')[0];
    await updateBusTimes(card, busStopCode);
  }
}

// æ›´æ–°å·´å£«æ—¶é—´
async function updateBusTimes(card, busStopCode) {
  const arrivalData = await getBusArrivalTimes(busStopCode);
  const busItems = card.querySelectorAll('.bus-item');
  
  busItems.forEach(busItem => {
    const busText = busItem.querySelector('span');
    const busNo = busText.textContent.split(' ')[0];
    
    // è·å–å®æ—¶åˆ°è¾¾æ—¶é—´
    let arrivalText1 = '--åˆ†é’Ÿ';
    let arrivalText2 = '--åˆ†é’Ÿ';
    let arrivalText3 = '--åˆ†é’Ÿ';
    
    if (arrivalData && arrivalData.Services) {
      const service = arrivalData.Services.find(s => s.ServiceNo === busNo);
      if (service) {
        if (service.NextBus && service.NextBus.EstimatedArrival) {
          const arrivalTime = new Date(service.NextBus.EstimatedArrival);
          const now = new Date();
          const minutes = Math.round((arrivalTime - now) / 60000);
          arrivalText1 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
        }
        if (service.NextBus2 && service.NextBus2.EstimatedArrival) {
          const arrivalTime = new Date(service.NextBus2.EstimatedArrival);
          const now = new Date();
          const minutes = Math.round((arrivalTime - now) / 60000);
          arrivalText2 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
        }
        if (service.NextBus3 && service.NextBus3.EstimatedArrival) {
          const arrivalTime = new Date(service.NextBus3.EstimatedArrival);
          const now = new Date();
          const minutes = Math.round((arrivalTime - now) / 60000);
          arrivalText3 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
        }
      }
    }
    
    const parts = busText.textContent.split('â†’');
    busText.innerHTML = `${busNo} ${arrivalText1}<br>â†’${parts[1].split(' ')[0]} ${arrivalText2} ${arrivalText3}`;
  });
}

// ---------- æ¸²æŸ“æ‰€æœ‰éƒ¨åˆ† ----------
async function renderAllSections() {
  if (currentView === 'default') {
    await renderFavorites();
    await renderNearbyStops();
    document.getElementById('favoriteSection').style.display = 'block';
    document.getElementById('nearbySection').style.display = 'block';
    document.getElementById('searchSection').style.display = 'none';
  } else {
    document.getElementById('favoriteSection').style.display = 'none';
    document.getElementById('nearbySection').style.display = 'none';
    document.getElementById('searchSection').style.display = 'block';
  }
}

// ---------- æ¸²æŸ“æ”¶è— ----------
async function renderFavorites(){
  const section = document.getElementById('favoriteSection');
  section.innerHTML = '<h3>æˆ‘çš„æ”¶è—</h3>';
  
  if(favoriteBuses.length===0){
    const empty=document.createElement('div');
    empty.className='busstop-card';
    empty.innerHTML='<p>æš‚æ— æ”¶è—</p>';
    section.appendChild(empty);
    return;
  }
  
  const grouped={};
  favoriteBuses.forEach(f=>{
    if(!grouped[f.BusStopCode]) grouped[f.BusStopCode]=[];
    grouped[f.BusStopCode].push(f.bus);
  });
  
  for (const stopCode of Object.keys(grouped)) {
    const bs=busStops.find(b=>b.BusStopCode===stopCode);
    if(!bs) continue;
    
    // è®¡ç®—æ”¶è—å·´å£«ç«™çš„è·ç¦»
    let distanceText = '';
    if (userPosition) {
      const dist = haversine(userPosition.lat, userPosition.lng, bs.Latitude, bs.Longitude);
      distanceText = `${Math.round(dist)}m`;
    }
    
    const card=document.createElement('div'); 
    card.className='busstop-card';
    
    // è·å–å®æ—¶æ•°æ®
    const arrivalData = await getBusArrivalTimes(stopCode);
    
    card.innerHTML=`<div class="busstop-header">
      <h3>${bs.Description}</h3>
      <p>${bs.BusStopCode} ${distanceText} ${bs.RoadName}</p>
    </div><div class="separator"></div><div class="bus-list show"></div>`;
    
    const listDiv=card.querySelector('.bus-list');
    
    // æ”¶è—ç½®é¡¶
    grouped[stopCode].forEach(bus=>{
      const busDiv=document.createElement('div'); 
      busDiv.className='bus-item';
      
      // è·å–å®æ—¶åˆ°è¾¾æ—¶é—´
      let arrivalText1 = '--åˆ†é’Ÿ';
      let arrivalText2 = '--åˆ†é’Ÿ';
      let arrivalText3 = '--åˆ†é’Ÿ';
      
      if (arrivalData && arrivalData.Services) {
        const service = arrivalData.Services.find(s => s.ServiceNo === bus.ServiceNo);
        if (service) {
          if (service.NextBus && service.NextBus.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText1 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
          if (service.NextBus2 && service.NextBus2.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus2.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText2 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
          if (service.NextBus3 && service.NextBus3.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus3.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText3 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
        }
      }
      
      busDiv.innerHTML=`<span>${bus.ServiceNo} ${arrivalText1}<br>â†’${bus.Destination} ${arrivalText2} ${arrivalText3}</span>
        <span class="star" data-bus="${bus.ServiceNo}" data-stop="${bs.BusStopCode}">&#9733;</span>`;
      listDiv.appendChild(busDiv);
      
      busDiv.querySelector('.star').onclick=e=>{
        e.stopPropagation();
        toggleFavorite(bs.BusStopCode,bus);
      };
      
      busDiv.onclick=()=>showBusModal(bus);
    });
    
    section.appendChild(card);
  }
}

// ---------- æ¸²æŸ“é™„è¿‘ç«™ç‚¹ ----------
async function renderNearbyStops(){
  const section = document.getElementById('nearbySection');
  section.innerHTML = '<h3>é™„è¿‘å·´å£«</h3>';
  const stops = getNearbyBusStops();
  
  if(stops.length === 0){
    const empty=document.createElement('div');
    empty.className='busstop-card';
    empty.innerHTML='<p>æ— æ³•è·å–ä½ç½®ä¿¡æ¯æˆ–500ç±³å†…æ²¡æœ‰å·´å£«ç«™</p>';
    section.appendChild(empty);
    return;
  }
  
  for (const bs of stops) {
    const card=document.createElement('div'); 
    card.className='busstop-card';
    
    // è·å–è¯¥ç«™æ‰€æœ‰å·´å£«ï¼ˆå»é‡ï¼‰
    let buses=getNextBuses(bs.BusStopCode);
    // æ”¶è—çš„ç½®é¡¶
    const favBuses=favoriteBuses.filter(f=>f.BusStopCode===bs.BusStopCode).map(f=>f.bus);
    const otherBuses=buses.filter(b=>!favBuses.some(f=>f.ServiceNo===b.ServiceNo));
    buses=[...favBuses,...otherBuses];
    
    // è·å–å®æ—¶æ•°æ®
    const arrivalData = await getBusArrivalTimes(bs.BusStopCode);
    
    card.innerHTML=`<div class="busstop-header">
      <h3>${bs.Description}</h3>
      <p>${bs.BusStopCode} ${Math.round(bs.distance||0)}m ${bs.RoadName}</p>
    </div><div class="separator"></div><div class="bus-list"></div>`;
    
    const listDiv=card.querySelector('.bus-list');
    
    buses.forEach(bus=>{
      const isFav=favoriteBuses.some(f=>f.BusStopCode===bs.BusStopCode && f.bus.ServiceNo===bus.ServiceNo);
      const busDiv=document.createElement('div'); 
      busDiv.className='bus-item';
      
      // è·å–å®æ—¶åˆ°è¾¾æ—¶é—´
      let arrivalText1 = '--åˆ†é’Ÿ';
      let arrivalText2 = '--åˆ†é’Ÿ';
      let arrivalText3 = '--åˆ†é’Ÿ';
      
      if (arrivalData && arrivalData.Services) {
        const service = arrivalData.Services.find(s => s.ServiceNo === bus.ServiceNo);
        if (service) {
          if (service.NextBus && service.NextBus.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText1 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
          if (service.NextBus2 && service.NextBus2.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus2.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText2 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
          if (service.NextBus3 && service.NextBus3.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus3.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText3 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
        }
      }
      
      busDiv.innerHTML=`<span>${bus.ServiceNo} ${arrivalText1}<br>â†’${bus.Destination} ${arrivalText2} ${arrivalText3}</span>
        <span class="star ${isFav?'':'unfilled'}" data-bus="${bus.ServiceNo}" data-stop="${bs.BusStopCode}">&#9733;</span>`;
      listDiv.appendChild(busDiv);
      
      busDiv.querySelector('.star').onclick=e=>{
        e.stopPropagation();
        toggleFavorite(bs.BusStopCode,bus);
      };
      
      busDiv.onclick=()=>showBusModal(bus);
    });
    
    card.querySelector('.busstop-header').onclick=()=>{ 
      listDiv.classList.toggle('show'); 
    };
    
    section.appendChild(card);
  }
}

// ---------- å¼¹çª— ----------
function showBusModal(bus){
  const modal=document.getElementById('busModal');
  document.getElementById('modalBusNo').innerText=`å·´å£« ${bus.ServiceNo}`;
  const tabs=document.getElementById('modalTabs');
  const contents=document.getElementById('modalTabContents');
  tabs.innerHTML=''; contents.innerHTML='';

  // Tab 1: è¥è¿æ—¶é—´
  const tab1=document.createElement('button'); tab1.innerText='è¥è¿æ—¶é—´';
  const content1=document.createElement('div'); content1.className='tab-content';
  content1.innerHTML=renderOpHours(bus);
  tabs.appendChild(tab1); contents.appendChild(content1);

  // Tab 2: è·¯çº¿
  const tab2=document.createElement('button'); tab2.innerText='è·¯çº¿å›¾';
  const content2=document.createElement('div'); content2.className='tab-content';
  content2.innerHTML=renderRouteMap(bus);
  tabs.appendChild(tab2); contents.appendChild(content2);

  [tab1,tab2].forEach((btn,idx)=>{
    btn.onclick=()=>{
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      contents.children[idx].classList.add('active');
    };
  });
  tab1.click();
  modal.style.display='flex';
}

// è¥è¿æ—¶é—´è¡¨
function renderOpHours(bus){
  return `<table class="op-table">
    <tr><th>ç±»å‹</th><th>é¦–ç­è½¦</th><th>æœ«ç­è½¦</th></tr>
    <tr><td>å·¥ä½œæ—¥</td><td>${bus.WD_FirstBus}</td><td>${bus.WD_LastBus}</td></tr>
    <tr><td>æ˜ŸæœŸå…­</td><td>${bus.SAT_FirstBus}</td><td>${bus.SAT_LastBus}</td></tr>
    <tr><td>æ˜ŸæœŸæ—¥/å…¬å…±å‡æ—¥</td><td>${bus.SUN_FirstBus}</td><td>${bus.SUN_LastBus}</td></tr>
  </table>`;
}

// è·¯çº¿å›¾

function renderRouteMap(bus){
  // ä½¿ç”¨æ‚¨æä¾›çš„æ–¹æ³•è·å–è·¯çº¿
  const matchedRoutes = busRoutes
    .filter(route => route.ServiceNo === bus.ServiceNo && route.Direction === bus.Direction)
    .sort((a, b) => a.Direction - b.Direction || a.StopSequence - b.StopSequence);

  // æ‰¾åˆ°ç¦»ç”¨æˆ·æœ€è¿‘çš„ç«™ç‚¹
  let nearestStopCode = null;
  if(userPosition){
    let minDist = Infinity;
    matchedRoutes.forEach(route=>{
      const stop = busStops.find(bs=>bs.BusStopCode===route.BusStopCode);
      if(!stop) return;
      const dist = haversine(userPosition.lat,userPosition.lng,stop.Latitude,stop.Longitude);
      if(dist < minDist){
        minDist = dist;
        nearestStopCode = stop.BusStopCode;
      }
    });
  }

  return `<div class="route-map">${
    matchedRoutes.map((route,i)=>{
      const stop=busStops.find(bs=>bs.BusStopCode===route.BusStopCode);
      if(!stop) return '';

      let isCurrentStop = (stop.BusStopCode === nearestStopCode);

      let mrtIndicator = "";
      if(stop.Description.includes("MRT")||stop.Description.includes("LRT")) mrtIndicator=" ğŸš‡";

      return `<div class="route-stop">
        <div class="route-line">
          <div class="route-circle ${isCurrentStop ? 'current' : ''}"></div>
          ${i<matchedRoutes.length-1?'<div class="route-connector"></div>':''}
        </div>
        <div class="route-text">${stop.Description} (${stop.BusStopCode})${mrtIndicator}</div>
        <button class="route-refresh" data-stop="${stop.BusStopCode}" data-bus="${bus.ServiceNo}" data-direction="${bus.Direction}"><i class="fas fa-sync-alt"></i></button>
        <div class="route-times" id="times-${stop.BusStopCode}"></div>
      </div>`;
    }).join('')
  }</div>`;
}

// ç‚¹å‡»è·¯çº¿å›¾ä¸Šçš„åˆ·æ–°æŒ‰é’®

document.addEventListener("click", async e=>{
  if(e.target.closest('.route-refresh')){
    const refreshBtn = e.target.closest('.route-refresh');
    const stopCode = refreshBtn.dataset.stop;
    const busNo = refreshBtn.dataset.bus;
    const direction = parseInt(refreshBtn.dataset.direction);

    const timesDiv = document.getElementById(`times-${stopCode}`);
    timesDiv.innerHTML = 'åŠ è½½ä¸­...';

    const arrivalData = await getBusArrivalTimes(stopCode);
    if(arrivalData && arrivalData.Services){
      const service = arrivalData.Services.find(s => s.ServiceNo===busNo);
      let timesHTML = '--åˆ†é’Ÿ';
      if(service){
        let arrs=[];
        [service.NextBus,service.NextBus2,service.NextBus3].forEach(nb=>{
          if(nb && nb.EstimatedArrival){
            const mins=Math.round((new Date(nb.EstimatedArrival)-new Date())/60000);
            arrs.push(mins>0?`${mins}åˆ†é’Ÿ`:'å³å°†åˆ°è¾¾');
          }
        });
        timesHTML = arrs.join(', ');
      }
      timesDiv.innerHTML = timesHTML;
    } else timesDiv.innerHTML = 'æš‚æ— å·´å£«ä¿¡æ¯';
  }
});

// ---------- äº‹ä»¶ç»‘å®š ----------

document.getElementById('modalClose').onclick = () => {
  document.getElementById('busModal').style.display = 'none';
};

// æœç´¢æŒ‰é’®ç‚¹å‡»é€»è¾‘ï¼Œè§¦å‘æ¨¡ç³ŠåŒ¹é…
document.getElementById('searchBtn').onclick = async () => {
  const val = searchInput.value.trim();
  if (!val) {
    currentView = 'default';
    renderAllSections();
    return;
  }

  currentView = 'search';
  
  // è§¦å‘ input äº‹ä»¶æ‰§è¡Œæ¨¡ç³ŠåŒ¹é…
  searchInput.dispatchEvent(new Event('input'));
};

// æ¸²æŸ“æœç´¢å·´å£«ç»“æœ
async function renderSearchBuses(busCode, routes) {
  const section = document.getElementById('searchSection');
  section.innerHTML = '<h3>æœç´¢ç»“æœ</h3>';
  
  if(routes.length === 0){
    const empty=document.createElement('div');
    empty.className='busstop-card';
    empty.innerHTML='<p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
    section.appendChild(empty);
    return;
  }
  
  // æŒ‰æ–¹å‘åˆ†ç»„
  const directions = [...new Set(routes.map(r => r.Direction))];
  
  for (const direction of directions) {
    const card=document.createElement('div'); 
    card.className='busstop-card';
    
    card.innerHTML=`<div class="busstop-header">
      <h3>å·´å£« ${busCode} - æ–¹å‘ ${direction}</h3>
    </div><div class="separator"></div><div class="bus-list show"></div>`;
    
    const listDiv=card.querySelector('.bus-list');
    
    // æ˜¾ç¤ºå·´å£«ä¿¡æ¯
    const busDiv=document.createElement('div'); 
    busDiv.className='bus-item';
    busDiv.innerHTML=`<span>ç‚¹å‡»æŸ¥çœ‹è·¯çº¿å›¾</span>`;
    busDiv.onclick=()=>{
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„å·´å£«å¯¹è±¡ç”¨äºæ˜¾ç¤ºè·¯çº¿å›¾
      const tempBus = {
        ServiceNo: busCode,
        Direction: direction,
        WD_FirstBus: '--',
        WD_LastBus: '--',
        SAT_FirstBus: '--',
        SAT_LastBus: '--',
        SUN_FirstBus: '--',
        SUN_LastBus: '--'
      };
      showBusModal(tempBus);
    };
    listDiv.appendChild(busDiv);
    
    section.appendChild(card);
  }
}

// æ¨¡ç³ŠåŒ¹é…
const searchInput=document.getElementById('searchInput');
const searchSection=document.getElementById('searchSection');

searchInput.addEventListener('input', ()=>{
  const val=searchInput.value.trim();
  if(!val){
    searchSection.style.display='none';
    return;
  }
  
  let matches=[];
  if(/^\d{1,5}$/.test(val)){
    matches=busStops.filter(bs=>bs.BusStopCode.includes(val) || bs.Description.includes(val));
  } else {
    matches=busServices.filter(svc=>svc.ServiceNo.includes(val));
  }

  let html='';
  matches.forEach(m=>{
    if(m.BusStopCode){
      html+=`<div class="busstop-card" style="cursor:pointer;" data-stop="${m.BusStopCode}">${m.Description} (${m.BusStopCode})</div>`;
    } else {
      html+=`<div class="busstop-card" style="cursor:pointer;" data-bus="${m.ServiceNo}">å·´å£« ${m.ServiceNo}</div>`;
    }
  });
  searchSection.innerHTML='<h3>æœç´¢ç»“æœ</h3>'+html;
  searchSection.style.display='block';

  // ç‚¹å‡»åŒ¹é…é¡¹
  searchSection.querySelectorAll('.busstop-card').forEach(el=>{
    el.onclick=async ()=>{
      if(el.dataset.stop){
        const bs=busStops.find(b=>b.BusStopCode===el.dataset.stop);
        if(bs) await renderSearchResults([bs]);
      } else if(el.dataset.bus){
        const svc=busServices.find(s=>s.ServiceNo===el.dataset.bus);
        if(svc){
          await renderSearchBuses(el.dataset.bus,busRoutes.filter(r=>r.ServiceNo===el.dataset.bus));
        }
      }
    };
  });
});

// æ¸²æŸ“æœç´¢å·´å£«ç«™ç»“æœ
async function renderSearchResults(stops) {
  const section = document.getElementById('searchSection');
  section.innerHTML = '<h3>æœç´¢ç»“æœ</h3>';
  
  if(stops.length === 0){
    const empty=document.createElement('div');
    empty.className='busstop-card';
    empty.innerHTML='<p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
    section.appendChild(empty);
    return;
  }
  
  for (const bs of stops) {
    const card=document.createElement('div'); 
    card.className='busstop-card';
    
    // è·å–è¯¥ç«™æ‰€æœ‰å·´å£«ï¼ˆå»é‡ï¼‰
    let buses=getNextBuses(bs.BusStopCode);
    
    // è·å–å®æ—¶æ•°æ®
    const arrivalData = await getBusArrivalTimes(bs.BusStopCode);
    
    card.innerHTML=`<div class="busstop-header">
      <h3>${bs.Description}</h3>
      <p>${bs.BusStopCode} ${userPosition ? Math.round(bs.distance||0)+'m' : ''} ${bs.RoadName}</p>
    </div><div class="separator"></div><div class="bus-list show"></div>`;
    
    const listDiv=card.querySelector('.bus-list');
    
    buses.forEach(bus=>{
      const isFav=favoriteBuses.some(f=>f.BusStopCode===bs.BusStopCode && f.bus.ServiceNo===bus.ServiceNo);
      const busDiv=document.createElement('div'); 
      busDiv.className='bus-item';
      
      // è·å–å®æ—¶åˆ°è¾¾æ—¶é—´
      let arrivalText1 = '--åˆ†é’Ÿ';
      let arrivalText2 = '--åˆ†é’Ÿ';
      let arrivalText3 = '--åˆ†é’Ÿ';
      
      if (arrivalData && arrivalData.Services) {
        const service = arrivalData.Services.find(s => s.ServiceNo === bus.ServiceNo);
        if (service) {
          if (service.NextBus && service.NextBus.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText1 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
          if (service.NextBus2 && service.NextBus2.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus2.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText2 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
          if (service.NextBus3 && service.NextBus3.EstimatedArrival) {
            const arrivalTime = new Date(service.NextBus3.EstimatedArrival);
            const now = new Date();
            const minutes = Math.round((arrivalTime - now) / 60000);
            arrivalText3 = minutes > 0 ? `${minutes}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾';
          }
        }
      }
      
      busDiv.innerHTML=`<span>${bus.ServiceNo} ${arrivalText1}<br>â†’${bus.Destination} ${arrivalText2} ${arrivalText3}</span>
        <span class="star ${isFav?'':'unfilled'}" data-bus="${bus.ServiceNo}" data-stop="${bs.BusStopCode}">&#9733;</span>`;
      listDiv.appendChild(busDiv);
      
      busDiv.querySelector('.star').onclick=e=>{
        e.stopPropagation();
        toggleFavorite(bs.BusStopCode,bus);
      };
      
      busDiv.onclick=()=>showBusModal(bus);
    });
    
    section.appendChild(card);
  }
}

document.getElementById('refreshBtn').onclick=()=>{
  if(navigator.geolocation){ 
    navigator.geolocation.getCurrentPosition(pos=>{
      userPosition={lat:pos.coords.latitude,lng:pos.coords.longitude};
      renderAllSections();
    }); 
  }
};

// è‡ªåŠ¨åˆ·æ–°å‡½æ•°
function startAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
  
  refreshInterval = setInterval(async () => {
    console.log('è‡ªåŠ¨åˆ·æ–°æ—¶é—´...');
    await refreshTimesOnly(); // åªåˆ·æ–°æ—¶é—´ï¼Œä¸åˆ·æ–°æ•´ä¸ªç•Œé¢
  }, 10000); // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
}

// ç›‘å¬æœç´¢æ¡†å˜åŒ–
document.getElementById('searchInput').addEventListener('input', function() {
  if (this.value.trim() === '') {
    currentView = 'default';
    renderAllSections();
  }
});

function pauseAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
    refreshInterval = null;
  }
}

function resumeAutoRefresh() {
  if (!refreshInterval) {
    refreshInterval = setInterval(async () => {
      if(currentView === 'default') {
        await refreshTimesOnly();
      }
    }, 10000);
  }
}

function showSearchView() {
  document.getElementById('favoriteSection').style.display = 'none';
  document.getElementById('nearbySection').style.display = 'none';
  searchSection.style.display = 'block';
}

function showDefaultView() {
  document.getElementById('favoriteSection').style.display = 'block';
  document.getElementById('nearbySection').style.display = 'block';
  searchSection.style.display = 'none';
}

// ---------- åˆå§‹åŒ– ----------
(async function(){ 
  await loadData();
  if(navigator.geolocation){ 
    navigator.geolocation.getCurrentPosition(pos=>{
      userPosition={lat:pos.coords.latitude,lng:pos.coords.longitude};
      renderAllSections();
      startAutoRefresh(); // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
    }, () => {
      // å¦‚æœå®šä½å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç«™ç‚¹
      renderAllSections();
      startAutoRefresh(); // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
    }); 
  } else {
    // å¦‚æœæ²¡æœ‰å®šä½æƒé™ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç«™ç‚¹
    renderAllSections();
    startAutoRefresh(); // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
  }

// ----------------- æœç´¢é€»è¾‘ -----------------

// ç»‘å®šäº‹ä»¶
document.getElementById('searchBtn').onclick = performSearch;
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('input', performSearch);

// æ‰§è¡Œæœç´¢

async function performSearch() {
  const val = searchInput.value.trim();
  if(!val) {
    currentView = 'default';
    showDefaultView();
    resumeAutoRefresh(); // å›åˆ°é»˜è®¤è§†å›¾ï¼Œæ¢å¤åˆ·æ–°
    renderAllSections();
    return;
  }

  currentView = 'search';
  showSearchView();
  pauseAutoRefresh(); // æœç´¢æ—¶æš‚åœåˆ·æ–°
  searchSection.innerHTML = '<h3>æœç´¢ç»“æœ</h3>';

  let busMatches = busServices.filter(svc => svc.ServiceNo.startsWith(val));
  let stopMatches = busStops.filter(bs => bs.BusStopCode.startsWith(val) || bs.Description.startsWith(val));

  let html = '';
  if(busMatches.length){
    html += '<h4>å·´å£«å·</h4>';
    busMatches.forEach(b => {
      html += `<div class="busstop-card" style="cursor:pointer;" data-bus="${b.ServiceNo}">å·´å£« ${b.ServiceNo}</div>`;
    });
  }
  if(stopMatches.length){
    html += '<h4>å·´å£«ç«™</h4>';
    stopMatches.forEach(s => {
      html += `<div class="busstop-card" style="cursor:pointer;" data-stop="${s.BusStopCode}">${s.Description} (${s.BusStopCode})</div>`;
    });
  }
  if(!busMatches.length && !stopMatches.length){
    html += '<p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
  }
  searchSection.innerHTML += html;

  // ç‚¹å‡»æ¡ç›®æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  searchSection.querySelectorAll('.busstop-card').forEach(el => {
    el.onclick = async () => {
      if(el.dataset.bus){
        const svc = busServices.find(s => s.ServiceNo === el.dataset.bus);
        const routes = busRoutes.filter(r => r.ServiceNo === el.dataset.bus);
        await renderSearchBuses(el.dataset.bus, routes);
      } else if(el.dataset.stop){
        const bs = busStops.find(b => b.BusStopCode === el.dataset.stop);
        if(bs) await renderSearchResults([bs]);
      }
    };
  });
}

})();
</script>

</body>
</html>