<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SG Bus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      crossorigin="anonymous" />
    <style>
      /* é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
      body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f5f5;
      }
      /* å¸ƒå±€å®¹å™¨ */
      .responsive-wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 10px;
      }
      .busstop-container { 
      display: flex; 
      flex-direction: column; 
      }
      /* æ ‡é¢˜å’Œæ–‡æœ¬æ ·å¼ */
      h2 {
      text-align: center;
      margin-bottom: 10px;
      }
      h3 {
      margin: 0;
      font-size: 18px;
      }
      /* å­—ä½“å¤§å°ç±» */
      .bus-no, .busstop-name, .text-bold-lg, .icon-lg { 
      font-weight: bold; 
      font-size: 20px; 
      }
      .text-sm, .icon-sm { 
      font-size: 13px; 
      }
      .busstop-info { 
      font-size: 16px; 
      }
      .bus-time-main, .text-time-main { 
      font-size: 14px; 
      display: inline-block; 
      width: 240px; 
      text-align: right; 
      vertical-align: middle; 
      }
      .bus-time-sub, .bus-dest { 
      font-size: 14px; 
      }
      /* æ§åˆ¶å…ƒç´ æ ·å¼ */
      .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
      }
      input,
      button {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
      }
      button {
      cursor: pointer;
      background: #007bff;
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      gap: 5px;
      }
      button:hover {
      background: #0056b3;
      }
      /* æœç´¢è¾“å…¥æ¡† */
      #searchInput {
      padding-left: 35px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 12px center;
      background-size: 16px;
      }
      /* å·´å£«ç«™å¡ç‰‡æ ·å¼ */
      .busstop-card {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .busstop-header { 
      cursor: pointer; 
      }
      .busstop-header p { 
      margin: 2px 0; 
      color: #666; 
      font-size: 14px; 
      }
      /* å·´å£«åˆ—è¡¨æ ·å¼ */
      .bus-list {
      display: none;
      flex-direction: column;
      }
      .bus-list.show { 
      display: flex; 
      }
      .bus-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.9);
      border-top: 1px solid rgba(187, 222, 251, 0.5);
      cursor: pointer;
      }
      /* åˆ†éš”çº¿ */
      .separator {
      border-top: 1px solid #ccc;
      margin: 8px 0;
      display: none;
      }
      .bus-list.show + .separator { 
      display: block; 
      }
      /* æ”¶è—æ˜Ÿæ ‡ */
      .star { 
      cursor: pointer; 
      font-size: 26px; 
      color: #ffcc00; 
      }
      .star.unfilled { 
      color: #ccc; 
      }
      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
      display: none;
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      }
      .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 500px;
      overflow: auto;
      }
      .modal-close {
      float: right;
      cursor: pointer;
      font-size: 32px;
      }
      /* æ ‡ç­¾é¡µæ ·å¼ */
      .tab {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      }
      .tab button { 
      flex: 1; 
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #007bff;
      background: #e3f2fd;
      color: #007bff;
      }
      .tab-content { 
      display: none; 
      margin-top: 10px; 
      }
      .tab-content.active { 
      display: block; 
      }
      /* è·¯çº¿å›¾æ ·å¼ */
      .route-map { 
      margin-top: 10px; 
      font-size: 15px; 
      }
      .route-stop { 
      margin-bottom: 5px; 
      }
      .route-text {
      margin-left: 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
      }
      .route-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      }
      .route-stop-clickable:hover {
      color: #007bff;
      text-decoration: none;
      }
      .route-times { 
      margin-top: 3px; 
      font-size: 12px; 
      color: #666; 
      }
      /* åˆ·æ–°æŒ‰é’® */
      .route-refresh {
      margin-left: 10px;
      background: transparent;
      border: none;
      color: #007bff;
      cursor: pointer;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
      border-radius: 0;
      transition: transform 0.5s ease;
      }
      .route-refresh:active,
      .route-refresh:focus,
      .route-refresh:hover { 
      background: transparent !important;
      color: #007bff !important; 
      }
      .route-refresh.rotate { 
      animation: clickRotate 0.5s ease;
      }
      /* è¥è¿æ—¶é—´è¡¨æ ¼ */
      .op-table {
      border-collapse: collapse;
      margin-top: 5px;
      font-size: 14px;
      width: 100%;
      }
      .op-table th {
      background: #0056b3;
      color: white;
      font-weight: bold;
      padding: 8px 12px;
      }
      .op-table td, .op-table th {
      border: 1px solid #ccc;
      padding: 3px 8px;
      text-align: center;
      }
      .op-table td:first-child { 
      width: 40%; 
      text-align: center; 
      }
      .op-table th:nth-child(2),
      .op-table td:nth-child(2),
      .op-table th:nth-child(3),
      .op-table td:nth-child(3) { 
      width: 30%; 
      }
      /* åŠ¨ç”» */
      @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
      }
      @keyframes clickRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
      }
      .hourglass-spin {
      animation: spin 5s linear infinite;
      display: inline-block;
      }
      .route-refresh.loading { 
      animation: spin 1s linear infinite; 
      color: #0056b3; 
      }
      /* å…¶ä»–å…ƒç´  */
      #backBtn { 
      display: none; 
      margin: 10px auto; 
      }
      .refresh-time { 
      font-size: 12px; 
      color: #666; 
      margin-left: 10px; 
      }
      .search-section { 
      margin-bottom: 15px; 
      }
      #searchBtn { 
      display: none; 
      }
      /* å“åº”å¼è®¾è®¡ */
      @media screen and (min-width: 768px) { 
      .responsive-wrapper { 
      max-width: 700px; 
      } 
      }
      @media screen and (min-width: 1024px) { 
      .responsive-wrapper { 
      max-width: 900px; 
      } 
      }
    </style>
  </head>
  <body>
    <h2><i class="fas fa-bus"></i> Singapore Bus</h2>
    <div class="controls">
      <input type="text" id="searchInput" placeholder="è¾“å…¥å·ç ">
      <button id="searchBtn"><i class="fas fa-search"></i> æŸ¥è¯¢</button>
      <button id="refreshBtn"><i class="fas fa-location-crosshairs"></i> åˆ·æ–°</button>
    </div>
    <div class="favorite-section" id="favoriteSection">
      <h3><i class="fas fa-heart"></i> æˆ‘çš„æ”¶è—</h3>
      <div class="busstop-card">
        <p><i class="far fa-star"></i> æš‚æ— æ”¶è—</p>
      </div>
    </div>
    <div class="nearby-section" id="nearbySection">
      <h3><i class="fas fa-map-marker-alt"></i> é™„è¿‘å·´å£«</h3>
    </div>
    <div class="search-section" id="searchSection" style="display:none;">
      <h3><i class="fas fa-search"></i> æœç´¢ç»“æœ</h3>
    </div>
    <div class="busstop-container" id="busstopContainer"></div>
    <div class="modal" id="busModal">
      <div class="modal-content">
        <span class="modal-close" id="modalClose">&times;</span>
        <h3 id="modalBusNo"></h3>
        <div class="tab" id="modalTabs"></div>
        <div id="modalTabContents"></div>
      </div>
    </div>
    <script>
      // å¸¸é‡å®šä¹‰
      const BUS_STOPS_URL = "json/busStops.json";
      const BUS_ROUTES_URL = "json/busRoutes.json";
      const BUS_SERVICES_URL = "json/busServices.json";
      const BUS_ARRIVAL_API = "https://busapi.0515364.xyz/busarrival?BusStopCode=";
      
      // å˜é‡å£°æ˜
      let busStops = [], busRoutes = [], busServices = [];
      let userPosition = null;
      let favoriteBuses = JSON.parse(localStorage.getItem('favoriteBuses') || '[]');
      let refreshInterval = null;
      let currentView = 'default'; // 'default', 'search'
      
      // å·¥å…·å‡½æ•°
      function saveFavorites() { 
          localStorage.setItem('favoriteBuses', JSON.stringify(favoriteBuses)); 
      }
      
      function haversine(lat1, lon1, lat2, lon2) {
          const R = 6371000, toRad = x => x * Math.PI / 180;
          const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
          const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
          return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }
      
      // æ•°æ®åŠ è½½å‡½æ•°
      async function loadData() {
          [busStops, busRoutes, busServices] = await Promise.all([
              fetch(BUS_STOPS_URL).then(r => r.json()),
              fetch(BUS_ROUTES_URL).then(r => r.json()),
              fetch(BUS_SERVICES_URL).then(r => r.json())
          ]);
      }
      
      // API è°ƒç”¨å‡½æ•°
      async function getBusArrivalTimes(busStopCode) {
          try {
              const response = await fetch(`${BUS_ARRIVAL_API}${busStopCode}`);
              const data = await response.json();
              return data;
          } catch (error) {
              console.error("è·å–å®æ—¶æ•°æ®å¤±è´¥:", error);
              return null;
          }
      }
      
      // å·´å£«æ•°æ®å¤„ç†å‡½æ•°
      function getBusOperatingHours(busData) {
          return {
              WD_FirstBus: busData?.WD_FirstBus || '',
              WD_LastBus: busData?.WD_LastBus || '',
              SAT_FirstBus: busData?.SAT_FirstBus || '',
              SAT_LastBus: busData?.SAT_LastBus || '',
              SUN_FirstBus: busData?.SUN_FirstBus || '',
              SUN_LastBus: busData?.SUN_LastBus || ''
          };
      }
      
      function getNextBuses(busStopCode) {
          const matchedRoutes = busRoutes
              .filter(route => route.BusStopCode === busStopCode)
              .sort((a, b) => a.Direction - b.Direction || a.StopSequence - b.StopSequence);
          
          const uniqueBuses = [];
          const seen = new Set();
          
          matchedRoutes.forEach(route => {
              const key = `${route.ServiceNo}-${route.Direction}`;
              if (!seen.has(key)) {
                  seen.add(key);
                  uniqueBuses.push(route);
              }
          });
          
          return uniqueBuses.map(b => {
              const svc = busServices.find(s => s.ServiceNo === b.ServiceNo && s.Direction === b.Direction);
              const destStop = busStops.find(bs => bs.BusStopCode === (svc ? svc.DestinationCode : b.DestinationCode));
              const originStop = busStops.find(bs => bs.BusStopCode === (svc ? svc.OriginCode : b.BusStopCode));
              return {
                  ServiceNo: b.ServiceNo,
                  Operator: b.Operator,
                  Direction: b.Direction,
                  Origin: originStop ? `${originStop.Description}` : '',
                  Destination: destStop ? `${destStop.Description}` : '', 
                  ...getBusOperatingHours(b)
              };
          });
      }
        
      
      // ä½ç½®ç›¸å…³å‡½æ•°
      function getNearbyBusStops(limit = 20) {
          if (!userPosition) return [];
          return busStops.map(bs => {
              const dist = haversine(userPosition.lat, userPosition.lng, bs.Latitude, bs.Longitude);
              return { ...bs, distance: dist };
          }).sort((a, b) => a.distance - b.distance)
            .filter(bs => bs.distance <= 500)
            .slice(0, limit);
      }
      
      // æ”¶è—åŠŸèƒ½å‡½æ•°
      function toggleFavorite(busStopCode, bus) {
          const idx = favoriteBuses.findIndex(f => f.BusStopCode === busStopCode && f.bus.ServiceNo === bus.ServiceNo);
          const isFavorite = idx >= 0;
          
          if (isFavorite) {
              favoriteBuses.splice(idx, 1);
          } else {
              favoriteBuses.push({ BusStopCode: busStopCode, bus });
          }
          saveFavorites();
          
          // æ›´æ–°æ‰€æœ‰ç›¸å…³æ˜Ÿæ ‡çŠ¶æ€
          document.querySelectorAll(`.star[data-bus="${bus.ServiceNo}"][data-stop="${busStopCode}"]`).forEach(star => {
              if (isFavorite) {
                  star.classList.add('unfilled');
              } else {
                  star.classList.remove('unfilled');
              }
          });
          
          // ä»æ”¶è—åˆ—è¡¨ä¸­ç§»é™¤
          if (isFavorite) {
              const favoriteSection = document.getElementById('favoriteSection');
              const busCards = favoriteSection.querySelectorAll('.busstop-card');
              
              busCards.forEach(card => {
                  if (card.dataset.stop === busStopCode) {
                      const busItems = card.querySelectorAll('.bus-item');
                      busItems.forEach(item => {
                          const star = item.querySelector('.star');
                          if (star && star.dataset.bus === bus.ServiceNo) {
                              item.remove();
                          }
                      });
                      
                      const remainingBuses = card.querySelectorAll('.bus-item');
                      if (remainingBuses.length === 0) {
                          card.remove();
                      }
                  }
              });
              
              if (favoriteSection.querySelectorAll('.busstop-card').length === 0) {
                  favoriteSection.innerHTML = '<h3><i class="fas fa-heart"></i> æˆ‘çš„æ”¶è—</h3>'+
                      '<div class="busstop-card"><p><i class="far fa-star"></i> æš‚æ— æ”¶è—</p></div>';
              }
          } else {
              renderFavorites();
          }
      }
      
      // æ—¶é—´å¤„ç†å‡½æ•°
      function getArrivalTimes(service) {
          const arrivalTimes = [];
          
          if (service) {
              [service.NextBus, service.NextBus2, service.NextBus3].forEach(nextBus => {
                  if (nextBus && nextBus.EstimatedArrival) {
                      const arrivalTime = new Date(nextBus.EstimatedArrival);
                      const now = new Date();
                      const seconds = Math.round((arrivalTime - now) / 1000);
                      
                      if (seconds > 30) {
                          const minutes = Math.floor(seconds / 60);
                          const remainingSeconds = seconds % 60;
                          arrivalTimes.push(`${minutes}åˆ†${remainingSeconds}ç§’`);
                      } else if (seconds > 0) {
                          arrivalTimes.push(`${seconds}ç§’`);
                      } else {
                          arrivalTimes.push('å·²ç¦»å¼€');
                      }
                  }
              });
          }
          
          while (arrivalTimes.length < 3) {
              arrivalTimes.push('');
          }
          
          return arrivalTimes;
      }
      
      // åˆ·æ–°åŠŸèƒ½å‡½æ•°
      async function refreshTimesOnly() {
          const allCards = document.querySelectorAll('.busstop-card');
          
          for (const card of allCards) {
              const isInSearchSection = card.closest('#searchSection');
              
              if (currentView === 'search' && !isInSearchSection) {
                  continue;
              }
              
              const busItems = card.querySelectorAll('.bus-item');
              const header = card.querySelector('.busstop-header p');
              if (!header) continue;
              
              const busStopCode = card.dataset.stop;
              if (!busStopCode) continue;
              
              const arrivalData = await getBusArrivalTimes(busStopCode);
              
              busItems.forEach(busDiv => {
                  const span = busDiv.querySelector('span:first-child');
                  const starEl = busDiv.querySelector('.star');
                  if (!span || !starEl) return;
              
                  const busNo = starEl.dataset.bus;
                  const busStopCode = starEl.dataset.stop;
                  if (!busNo || !busStopCode) return;
                  const busInfo = getNextBuses(busStopCode).find(b => b.ServiceNo === busNo);
                  if (!busInfo) return;
                  const service = arrivalData.Services.find(s => s.ServiceNo === busNo);
                  const [arrivalText1, arrivalText2, arrivalText3] = getArrivalTimes(service);
              
                  span.innerHTML = `
                      <i class="fas fa-bus icon-lg"></i> 
                      <span class="text-bold-lg">${busNo}</span> 
                      <span class="text-time-main">
                          ${arrivalText1}
                          ${arrivalText1 ? '<i class="fas fa-cog hourglass-spin"></i>' : ''}
                      </span><br>
                      <i class="fas fa-arrow-circle-right icon-sm"></i> 
                      <span class="text-sm">${busInfo.Destination}</span> 
                      <span class="text-sm">
                          ${arrivalText2} ${arrivalText3}
                      </span>
                  `;
              });
          }
      }
      
      async function updateBusTimes(card, busStopCode) {
          const arrivalData = await getBusArrivalTimes(busStopCode);
          const busItems = card.querySelectorAll('.bus-item');
        
          busItems.forEach(busItem => {
              const busText = busItem.querySelector('span');
              const busNo = busText.textContent.split(' ')[0];
          
              const service = arrivalData.Services.find(s => s.ServiceNo === busNo);
              const [arrivalText1, arrivalText2, arrivalText3] = getArrivalTimes(service);
          
              busText.innerHTML = `
                  <i class="fas fa-bus"></i> ${busNo} ${arrivalText1}<br>
                  <i class="fas fa-arrow-circle-right"></i> ${bus.Destination} ${arrivalText2} ${arrivalText3}
              `;
          });
      }
      
      // è§†å›¾æ¸²æŸ“æ§åˆ¶å‡½æ•°
      async function renderAllSections() {
          if (currentView === 'default') {
              await renderFavorites();
              await renderNearbyStops();
              document.getElementById('favoriteSection').style.display = 'block';
              document.getElementById('nearbySection').style.display = 'block';
              document.getElementById('searchSection').style.display = 'none';
          } else {
              document.getElementById('favoriteSection').style.display = 'none';
              document.getElementById('nearbySection').style.display = 'none';
              document.getElementById('searchSection').style.display = 'block';
          }
      }
        
      
      // æ¸²æŸ“å‡½æ•°
      async function renderFavorites() {
          const section = document.getElementById('favoriteSection');
          section.innerHTML = '<h3><i class="fas fa-heart"></i> æˆ‘çš„æ”¶è—</h3>';
          
          if (favoriteBuses.length === 0) {
              const empty = document.createElement('div');
              empty.className = 'busstop-card';
              empty.innerHTML = '<p><i class="far fa-star"></i> æš‚æ— æ”¶è—</p>';
              section.appendChild(empty);
              return;
          }
          
          const grouped = {};
          favoriteBuses.forEach(f => {
              if (!grouped[f.BusStopCode]) grouped[f.BusStopCode] = [];
              grouped[f.BusStopCode].push(f.bus);
          });
          
          for (const stopCode of Object.keys(grouped)) {
              const bs = busStops.find(b => b.BusStopCode === stopCode);
              if (!bs) continue;
              
              let distance = null;
              if (userPosition) {
                  distance = haversine(userPosition.lat, userPosition.lng, bs.Latitude, bs.Longitude);
              }
              
              const distanceText = distance ? `${Math.round(distance)}m` : '';
              const card = document.createElement('div');
              card.className = 'busstop-card';
              card.dataset.stop = stopCode; 
              
              card.innerHTML = `
                  <div class="busstop-header">
                      <h3>
                          <i class="fas fa-directions icon-lg"></i> 
                          <span class="busstop-name">${bs.Description}</span>
                      </h3>
                      <p class="busstop-info">
                          <i class="fas fa-minus-circle icon-sm"></i> 
                          <span>${bs.BusStopCode}</span>
                          ${distanceText ? ` &nbsp;<i class="fas fa-location-arrow icon-sm"></i> <span>${distanceText}</span>` : ''}
                          &nbsp;<i class="fas fa-map-marked-alt icon-sm"></i> 
                          <span>${bs.RoadName}</span>
                      </p>
                  </div>
                  <div class="separator"></div>
                  <div class="bus-list show"></div>
              `;
              
              section.appendChild(card);
              const listDiv = card.querySelector('.bus-list');
              
              // æ¸²æŸ“æ”¶è—çš„å·´å£«é¡¹ç›®
              grouped[stopCode].forEach(bus => {
                  const busDiv = document.createElement('div');
                  busDiv.className = 'bus-item';
                  
                  busDiv.innerHTML = `
                      <span>
                          <i class="fas fa-bus"></i> ${bus.ServiceNo}<br>
                          <i class="fas fa-arrow-circle-right"></i> ${bus.Destination}
                      </span>
                      <span class="star" data-bus="${bus.ServiceNo}" data-stop="${bs.BusStopCode}">&#9733;</span>
                  `;
                  
                  listDiv.appendChild(busDiv);
                  
                  // äº‹ä»¶ç›‘å¬å™¨
                  busDiv.querySelector('.star').onclick = e => {
                      e.stopPropagation();
                      toggleFavorite(bs.BusStopCode, bus);
                  };
                  
                  busDiv.onclick = () => {
                      bus.currentStopCode = bs.BusStopCode; 
                      showBusModal(bus);
                  };
              });
              
              // å¼‚æ­¥æ›´æ–°åˆ°è¾¾æ—¶é—´
              (async (listDiv, stopCode) => {
                  const arrivalData = await getBusArrivalTimes(stopCode);
                  listDiv.querySelectorAll('.bus-item').forEach(busDiv => {
                      const starEl = busDiv.querySelector('.star');
                      const serviceNo = starEl.dataset.bus;
                      const bus = grouped[stopCode].find(b => b.ServiceNo === serviceNo);
                      if (!bus) return;
                  
                      const service = arrivalData.Services.find(s => s.ServiceNo === serviceNo);
                      const [arrivalText1, arrivalText2, arrivalText3] = getArrivalTimes(service);
                  
                      const span = busDiv.querySelector('span');
                      span.innerHTML = `
                          <i class="fas fa-bus icon-lg"></i> 
                          <span class="text-bold-lg">${serviceNo}</span> 
                          <span class="text-time-main">
                              ${arrivalText1}
                              ${arrivalText1 ? '<i class="fas fa-cog hourglass-spin"></i>' : ''}
                          </span><br>
                          <i class="fas fa-arrow-circle-right icon-sm"></i> 
                          <span class="text-sm">${bus.Destination}</span> 
                          <span class="text-sm">
                              ${arrivalText2} ${arrivalText3}
                          </span>
                      `;
                  });
              })(listDiv, stopCode);
          }
      }
      
        
        async function renderNearbyStops() {
          const section = document.getElementById('nearbySection');
          section.innerHTML = '<h3><i class="fas fa-map-marker-alt"></i> é™„è¿‘å·´å£«</h3>';
          const stops = getNearbyBusStops();
          
          if (stops.length === 0) {
              const empty = document.createElement('div');
              empty.className = 'busstop-card';
              empty.innerHTML = '<p><i class="fas fa-exclamation-triangle"></i> æ— æ³•è·å–ä½ç½®ä¿¡æ¯æˆ–500ç±³å†…æ²¡æœ‰å·´å£«ç«™</p>';
              section.appendChild(empty);
              return;
          }
          
          for (const bs of stops) {
              const card = document.createElement('div');
              card.className = 'busstop-card';
              let buses = getNextBuses(bs.BusStopCode);
              const favBuses = favoriteBuses.filter(f => f.BusStopCode === bs.BusStopCode).map(f => f.bus);
              const otherBuses = buses.filter(b => !favBuses.some(f => f.ServiceNo === b.ServiceNo));
              buses = [...favBuses, ...otherBuses];
              const arrivalData = await getBusArrivalTimes(bs.BusStopCode);
              
              card.innerHTML = `
                  <div class="busstop-header">
                      <h3>
                          <i class="fas fa-directions icon-lg"></i> 
                          <span class="busstop-name">${bs.Description}</span>
                      </h3>
                      <p class="busstop-info">
                          <i class="fas fa-minus-circle icon-sm"></i> 
                          <span>${bs.BusStopCode}</span> &nbsp;
                          <i class="fas fa-location-arrow icon-sm"></i> 
                          <span>${Math.round(bs.distance || 0)}m</span> &nbsp;
                          <i class="fas fa-map-marked-alt icon-sm"></i> 
                          <span>${bs.RoadName}</span>
                      </p>
                  </div>
                  <div class="separator"></div>
                  <div class="bus-list"></div>
              `;
              
              const listDiv = card.querySelector('.bus-list');
              
              // æ¸²æŸ“å·´å£«é¡¹ç›®
              buses.forEach(bus => {
                  const isFav = favoriteBuses.some(f => f.BusStopCode === bs.BusStopCode && f.bus.ServiceNo === bus.ServiceNo);
                  const busDiv = document.createElement('div');
                  busDiv.className = 'bus-item';
              
                  const service = arrivalData.Services.find(s => s.ServiceNo === bus.ServiceNo);
                  const [arrivalText1, arrivalText2, arrivalText3] = getArrivalTimes(service);
              
                  busDiv.innerHTML = `
                      <span>
                          <i class="fas fa-bus icon-lg"></i> 
                          <span class="text-bold-lg">${bus.ServiceNo}</span> 
                          <span class="text-time-main">
                              ${arrivalText1}
                              ${arrivalText1 ? '<i class="fas fa-cog hourglass-spin"></i>' : ''}
                          </span><br>
                          <i class="fas fa-arrow-circle-right icon-sm"></i> 
                          <span class="text-sm">${bus.Destination}</span> 
                          <span class="text-sm">${arrivalText2} ${arrivalText3}</span>
                      </span>
                      <span class="star ${isFav ? '' : 'unfilled'}" data-bus="${bus.ServiceNo}" data-stop="${bs.BusStopCode}">&#9733;</span>
                  `;
                  
                  listDiv.appendChild(busDiv);
                  
                  // äº‹ä»¶ç›‘å¬å™¨
                  busDiv.querySelector('.star').onclick = e => {
                      e.stopPropagation();
                      toggleFavorite(bs.BusStopCode, bus);
                  };
                  
                  busDiv.onclick = () => {
                      bus.currentStopCode = bs.BusStopCode; 
                      showBusModal(bus);
                  };
              });
              
              // æŠ˜å /å±•å¼€åŠŸèƒ½
              const header = card.querySelector('.busstop-header');
              header.onclick = () => {
                  listDiv.classList.toggle('show');
                  const separator = card.querySelector('.separator');
                  separator.style.display = listDiv.classList.contains('show') ? 'block' : 'none';
              };
              
              section.appendChild(card);
          }
      }
      
      // æ¨¡æ€æ¡†å‡½æ•°
      function showBusModal(bus, activeTabIndex = 0) {
          const modal = document.getElementById('busModal');
          
          let currentStopInfo = '';
          if (bus.currentStopCode) {
              const currentStop = busStops.find(bs => bs.BusStopCode === bus.currentStopCode);
              if (currentStop) {
                  let distanceText = '';
                  if (userPosition) {
                      const distance = haversine(userPosition.lat, userPosition.lng, currentStop.Latitude, currentStop.Longitude);
                      distanceText = ` &nbsp;<i class="fas fa-location-arrow icon-sm"></i> <span>${Math.round(distance)}m</span>`;
                  }
                  
                  currentStopInfo = `
                      <div class="busstop-header" style="margin-bottom: 10px;">
                          <h3>
                              <i class="fas fa-directions icon-lg"></i> 
                              <span class="busstop-name">${currentStop.Description}</span>
                          </h3>
                          <p class="busstop-info">
                              <i class="fas fa-minus-circle icon-sm"></i> 
                              <span>${currentStop.BusStopCode}</span>
                              ${distanceText}
                              &nbsp;<i class="fas fa-map-marked-alt icon-sm"></i> 
                              <span>${currentStop.RoadName}</span>
                          </p>
                      </div>
                  `;
              }
          }
          
          document.getElementById('modalBusNo').innerHTML = `
              <div style="margin-bottom: 15px;">
                  ${currentStopInfo}
                  <div style="text-align: center; ${currentStopInfo ? 'padding-top: 10px; border-top: 1px solid #eee;' : ''}">
                      <div class="text-bold-lg">
                          <i class="fas fa-bus icon-lg"></i> ${bus.ServiceNo}
                      </div>
                  </div>
              </div>
          `;
          
          const tabs = document.getElementById('modalTabs');
          const contents = document.getElementById('modalTabContents');
          tabs.innerHTML = '';
          contents.innerHTML = '';
      
          // åˆ›å»ºæ ‡ç­¾é¡µ
          const tab1 = document.createElement('button');
          tab1.innerHTML = '<i class="fas fa-clock"></i> è¥è¿æ—¶é—´'; 
          const content1 = document.createElement('div');
          content1.className = 'tab-content';
          content1.innerHTML = renderOpHours(bus);
          tabs.appendChild(tab1);
          contents.appendChild(content1);
      
          const tab2 = document.createElement('button');
          tab2.innerHTML = '<i class="fas fa-route"></i> è·¯çº¿å›¾'; 
          const content2 = document.createElement('div');
          content2.className = 'tab-content';
          content2.innerHTML = renderRouteMap(bus);
          tabs.appendChild(tab2);
          contents.appendChild(content2);
      
          // æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
          [tab1, tab2].forEach((btn, idx) => {
              btn.onclick = () => {
                  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                  contents.children[idx].classList.add('active');
              };
          });
      
          // è®¾ç½®é»˜è®¤æ¿€æ´»çš„æ ‡ç­¾é¡µ
          if (activeTabIndex === 1) {
              tab2.click();
          } else {
              tab1.click();
          }
          
          modal.style.display = 'flex';
      }
        
      
      // æ¨¡æ€æ¡†å†…å®¹æ¸²æŸ“å‡½æ•°
      function renderOpHours(bus) {
          return `<table class="op-table">
              <tr><th>ç±»å‹</th><th>é¦–ç­è½¦</th><th>æœ«ç­è½¦</th></tr>
              <tr><td>å·¥ä½œæ—¥</td><td>${bus.WD_FirstBus}</td><td>${bus.WD_LastBus}</td></tr>
              <tr><td>æ˜ŸæœŸå…­</td><td>${bus.SAT_FirstBus}</td><td>${bus.SAT_LastBus}</td></tr>
              <tr><td>æ˜ŸæœŸæ—¥/å…¬å…±å‡æ—¥</td><td>${bus.SUN_FirstBus}</td><td>${bus.SUN_LastBus}</td></tr>
          </table>`;
      }
      
      function renderRouteMap(bus) {
          const matchedRoutes = busRoutes
              .filter(route => route.ServiceNo === bus.ServiceNo && route.Direction === bus.Direction)
              .sort((a, b) => a.StopSequence - b.StopSequence);
          
          let nearestStopCode = null;
          if (userPosition) {
              let minDist = Infinity;
              matchedRoutes.forEach(route => {
                  const stop = busStops.find(bs => bs.BusStopCode === route.BusStopCode);
                  if (!stop) return;
                  const dist = haversine(userPosition.lat, userPosition.lng, stop.Latitude, stop.Longitude);
                  if (dist < minDist && dist <= 1000) {
                      minDist = dist;
                      nearestStopCode = stop.BusStopCode;
                  }
              });
          }
          
          const validRoutes = matchedRoutes.filter(route => {
              const stop = busStops.find(bs => bs.BusStopCode === route.BusStopCode);
              return stop !== undefined;
          });
          
          if (validRoutes.length === 0) {
              return `<div class="route-map"><p>æš‚æ— è·¯çº¿ä¿¡æ¯</p></div>`;
          }
          
          return `<div class="route-map">${validRoutes.map((route, i) => {
              const stop = busStops.find(bs => bs.BusStopCode === route.BusStopCode);
              const isCurrentStop = stop.BusStopCode === nearestStopCode;
              const stopEmoji = isCurrentStop ? "ğŸ”´ " : "ğŸ”µ ";
              
              return `<div class="route-stop">
                  <div class="route-text">
                      <div class="route-info">
                          <span class="route-stop-clickable" data-stop="${stop.BusStopCode}" style="cursor: pointer; flex: 1;">
                              ${stopEmoji}${stop.Description} (${stop.BusStopCode})
                          </span>
                          <button class="route-refresh" data-stop="${stop.BusStopCode}" data-bus="${bus.ServiceNo}" data-direction="${bus.Direction}">
                              <i class="fas fa-sync-alt"></i>
                          </button>
                      </div>
                      <div class="route-times" id="times-${stop.BusStopCode}"></div>
                  </div>
              </div>`;
          }).join('')}</div>`;
      }
      
      // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
      let autoRefreshStops = new Set(); 
      
      document.addEventListener("click", async e => {
          const refreshBtn = e.target.closest('.route-refresh');
          if (!refreshBtn) return;
          
          const stopCode = refreshBtn.dataset.stop;
          const busNo = refreshBtn.dataset.bus;
          const direction = parseInt(refreshBtn.dataset.direction);
          
          if (autoRefreshStops.has(stopCode)) {
              autoRefreshStops.delete(stopCode);
              refreshBtn.classList.remove('loading');
          } else {
              autoRefreshStops.add(stopCode);
              refreshBtn.classList.add('loading');
          }
          
          await refreshSingleStop(stopCode, busNo, refreshBtn);
      });
      
      async function refreshSingleStop(stopCode, busNo, refreshBtn) {
          const timesDiv = document.getElementById(`times-${stopCode}`);
          
          refreshBtn.classList.add('rotate');
          timesDiv.innerHTML = 'åŠ è½½ä¸­...';
          
          try {
              const arrivalData = await getBusArrivalTimes(stopCode);
              
              if (arrivalData && arrivalData.Services) {
                  const service = arrivalData.Services.find(s => s.ServiceNo === busNo);
                  let timesHTML = '';
                  if (service) {
                      const arrs = [];
                      [service.NextBus, service.NextBus2, service.NextBus3].forEach(nb => {
                          if (nb && nb.EstimatedArrival) {
                              const mins = Math.round((new Date(nb.EstimatedArrival) - new Date()) / 60000);
                              arrs.push(mins > 0 ? `${mins}åˆ†é’Ÿ` : 'å³å°†åˆ°è¾¾');
                          }
                      });
                      timesHTML = `<span class="bus-number">${busNo}: </span>${arrs.join(', ')}`;
                  }
                  timesDiv.innerHTML = timesHTML;
              } else {
                  timesDiv.innerHTML = 'æš‚æ— å·´å£«ä¿¡æ¯';
              }
          } catch (error) {
              timesDiv.innerHTML = 'åŠ è½½å¤±è´¥';
          } finally {
              setTimeout(() => {
                  refreshBtn.classList.remove('rotate');
              }, 500);
          }
      }
      
      async function refreshAutoRefreshStops() {
          for (const stopCode of autoRefreshStops) {
              const refreshBtn = document.querySelector(`.route-refresh[data-stop="${stopCode}"]`);
              if (refreshBtn) {
                  const busNo = refreshBtn.dataset.bus;
                  await refreshSingleStop(stopCode, busNo, refreshBtn);
              }
          }
      }
      
      // äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('modalClose').onclick = () => {
          document.getElementById('busModal').style.display = 'none';
      };
      
      document.getElementById('searchBtn').onclick = async () => {
          const val = searchInput.value.trim();
          if (!val) {
              currentView = 'default';
              renderAllSections();
              return;
          }
          currentView = 'search';
          searchInput.dispatchEvent(new Event('input'));
      };
      
        
      
      // æœç´¢ç›¸å…³å‡½æ•°
      async function renderSearchBuses(busCode, routes) {
          const section = document.getElementById('searchSection');
          section.innerHTML = '<h3><i class="fas fa-search"></i>æœç´¢ç»“æœ</h3>';
          
          if (routes.length === 0) {
              const empty = document.createElement('div');
              empty.className = 'busstop-card';
              empty.innerHTML = '<div class="busstop-card"><p><i class="fas fa-exclamation-circle"></i> æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</p></div>';
              section.appendChild(empty);
              return;
          }
          
          const directions = [...new Set(routes.map(r => r.Direction))];
          
          for (const direction of directions) {
              const svc = busServices.find(s => s.ServiceNo === busCode && s.Direction === direction);
              const originStop = busStops.find(bs => bs.BusStopCode === svc?.OriginCode);
              const destStop = busStops.find(bs => bs.BusStopCode === svc?.DestinationCode);
              const originName = originStop ? originStop.Description : 'æœªçŸ¥èµ·ç‚¹';
              const destName = destStop ? destStop.Description : 'æœªçŸ¥ç»ˆç‚¹';
              
              const card = document.createElement('div');
              card.className = 'busstop-card';
              card.innerHTML = `
                  <div class="busstop-header">
                      <h3><i class="fas fa-bus"></i> ${busCode}<br>
                      <i class="fas fa-map-marker-alt"></i> ${originName} <i class="fas fa-long-arrow-alt-right"></i> ${destName}</h3>
                  </div>
                  <div class="separator"></div>
                  <div class="bus-list show"></div>
              `;
              
              const listDiv = card.querySelector('.bus-list');
              const busDiv = document.createElement('div');
              busDiv.className = 'bus-item';
              busDiv.innerHTML = `<span><i class="fas fa-route"></i> ç‚¹å‡»æŸ¥çœ‹è·¯çº¿å›¾</span>`;
              
              busDiv.onclick = () => {
                  const originStopData = busRoutes.find(r => r.ServiceNo === busCode && r.Direction === direction && r.StopSequence === 1);
                  const tempBus = {
                      ServiceNo: busCode,
                      Direction: direction,
                      OriginName: originName,
                      DestinationName: destName,
                      ...getBusOperatingHours(originStopData)
                  };
                  showBusModal(tempBus, 1);
              };
              
              listDiv.appendChild(busDiv);
              section.appendChild(card);
          }
      }
      
      async function renderSearchResults(stops) {
          const section = document.getElementById('searchSection');
          section.innerHTML = '<h3><i class="fas fa-search"></i> æœç´¢ç»“æœ</h3>';
          
          if (stops.length === 0) {
              const empty = document.createElement('div');
              empty.className = 'busstop-card';
              empty.innerHTML = '<div class="busstop-card"><p><i class="fas fa-exclamation-circle"></i> æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</p></div>';
              section.appendChild(empty);
              return;
          }
          
          for (const bs of stops) {
              const card = document.createElement('div');
              card.className = 'busstop-card';
              card.dataset.stop = bs.BusStopCode;
              
              if (userPosition && !bs.distance) {
                  bs.distance = haversine(userPosition.lat, userPosition.lng, bs.Latitude, bs.Longitude);
              }
              
              let buses = getNextBuses(bs.BusStopCode);
              const arrivalData = await getBusArrivalTimes(bs.BusStopCode);
              
              card.innerHTML = `
                  <div class="busstop-header">
                      <h3>
                          <i class="fas fa-directions icon-lg"></i> 
                          <span class="busstop-name">${bs.Description}</span>
                      </h3>
                      <p class="busstop-info">
                          <i class="fas fa-minus-circle icon-sm"></i> 
                          <span>${bs.BusStopCode}</span>
                          ${userPosition ? ` &nbsp;<i class="fas fa-location-arrow icon-sm"></i> 
                          <span>${Math.round(bs.distance || 0)}m</span>` : ''}
                          &nbsp;<i class="fas fa-map-marked-alt icon-sm"></i> 
                          <span>${bs.RoadName}</span>
                      </p>
                  </div>
                  <div class="separator"></div>
                  <div class="bus-list show"></div>
              `;
              
              const listDiv = card.querySelector('.bus-list');
              
              buses.forEach(bus => {
                  const isFav = favoriteBuses.some(f => f.BusStopCode === bs.BusStopCode && f.bus.ServiceNo === bus.ServiceNo);
                  const busDiv = document.createElement('div');
                  busDiv.className = 'bus-item';
              
                  const service = arrivalData.Services.find(s => s.ServiceNo === bus.ServiceNo);
                  const [arrivalText1, arrivalText2, arrivalText3] = getArrivalTimes(service);
              
                  busDiv.innerHTML = `
                      <span>
                          <i class="fas fa-bus icon-lg"></i> 
                          <span class="text-bold-lg">${bus.ServiceNo}</span> 
                          <span class="text-time-main">
                              ${arrivalText1}
                              ${arrivalText1 ? '<i class="fas fa-cog hourglass-spin"></i>' : ''}
                          </span><br>
                          <i class="fas fa-arrow-circle-right icon-sm"></i> 
                          <span class="text-sm">${bus.Destination}</span> 
                          <span class="text-sm">
                              ${arrivalText2} ${arrivalText3}
                          </span>
                      </span>
                      <span class="star ${isFav ? '' : 'unfilled'}" 
                            data-bus="${bus.ServiceNo}" 
                            data-stop="${bs.BusStopCode}">&#9733;</span>
                  `;
                  
                  listDiv.appendChild(busDiv);
                  
                  busDiv.querySelector('.star').onclick = e => {
                      e.stopPropagation();
                      toggleFavorite(bs.BusStopCode, bus);
                  };
                  
                  busDiv.onclick = () => {
                      bus.currentStopCode = bs.BusStopCode;
                      showBusModal(bus);
                  };
              });
              
              section.appendChild(card);
          }
      }
      
      // æœç´¢è¾“å…¥å¤„ç†
      const searchInput = document.getElementById('searchInput');
      const searchSection = document.getElementById('searchSection');
      
      searchInput.addEventListener('input', () => {
          const val = searchInput.value.trim();
          if (!val) {
              searchSection.style.display = 'none';
              return;
          }
      
          let matches = [];
          const valLower = val.toLowerCase(); 
          
          if (/^\d{1,5}$/.test(val)) {
              matches = busStops.filter(bs => 
                  bs.BusStopCode.includes(val) || 
                  bs.Description.toLowerCase().includes(valLower)
              );
          } else {
              const busStopMatches = busStops.filter(bs => 
                  bs.Description.toLowerCase().includes(valLower)
              );
              const busMatches = busServices.filter(svc => 
                  svc.ServiceNo.toLowerCase().includes(valLower)
              );
              matches = [...busStopMatches, ...busMatches];
          }
      
          let html = '';
          matches.forEach(m => {
              if (m.BusStopCode) {
                  html += `<div class="busstop-card" style="cursor:pointer;" data-stop="${m.BusStopCode}">${m.Description} (${m.BusStopCode})</div>`;
              } else {
                  html += `<div class="busstop-card" style="cursor:pointer;" data-bus="${m.ServiceNo}"> ${m.ServiceNo}</div>`;
              }
          });
      
          searchSection.innerHTML = '<h3><i class="fas fa-search"></i> æœç´¢ç»“æœ</h3>' + html;
          searchSection.style.display = 'block';
          
          searchSection.querySelectorAll('.busstop-card').forEach(el => {
              el.onclick = async () => {
                  if (el.dataset.stop) {
                      const bs = busStops.find(b => b.BusStopCode === el.dataset.stop);
                      if (bs) await renderSearchResults([bs]);
                  } else if (el.dataset.bus) {
                      const svc = busServices.find(s => s.ServiceNo === el.dataset.bus);
                      if (svc) {
                          await renderSearchBuses(el.dataset.bus, busRoutes.filter(r => r.ServiceNo === el.dataset.bus));
                      }
                  }
              };
          });
      });
      
      // åˆ·æ–°æŒ‰é’®äº‹ä»¶
      document.getElementById('refreshBtn').onclick = () => {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(pos => {
                  userPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                  renderAllSections();
              });
          }
      };
      
        
      // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶å‡½æ•°
      function pauseAutoRefresh() {
          stopAutoRefresh();
      }
      
      function resumeAutoRefresh() {
          if (!refreshInterval) startAutoRefresh();
      }
      
      // è§†å›¾æ§åˆ¶å‡½æ•°
      function showSearchView() {
          document.getElementById('favoriteSection').style.display = 'none';
          document.getElementById('nearbySection').style.display = 'none';
          searchSection.style.display = 'block';
      }
      
      function showDefaultView() {
          document.getElementById('favoriteSection').style.display = 'block';
          document.getElementById('nearbySection').style.display = 'block';
          searchSection.style.display = 'none';
      }
      
      // æœç´¢è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('searchInput').addEventListener('input', function () {
          if (this.value.trim() === '') {
              currentView = 'default';
              resumeAutoRefresh();
          } else {
              currentView = 'search';
              pauseAutoRefresh();
          }
      });
      
      // ä¸»åˆå§‹åŒ–å‡½æ•°
      (async function () {
          await loadData();
          
          let hasDataDisplayed = false;
          let autoRefreshTimer = null;
          let currentView = 'default';
          let expandedStopCode = null;
          
          // è®¾ç½®è¶…æ—¶æ£€æŸ¥
          const displayTimeout = setTimeout(() => {
              if (!hasDataDisplayed) {
                  renderAllSections();
              }
          }, 3000);
      
          // æ•°æ®æˆåŠŸæ˜¾ç¤ºåçš„å›è°ƒ
          function onDataDisplayed() {
              hasDataDisplayed = true;
              clearTimeout(displayTimeout);
          }
      
          // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
          function startAutoRefresh() {
              stopAutoRefresh();
              autoRefreshTimer = setInterval(async () => {
                  if (currentView === 'default') {
                      await refreshTimesOnly();
                  } else if (currentView === 'search') {
                      await refreshTimesOnly();
                  }
      
                  if (autoRefreshStops.size > 0) {
                      await refreshAutoRefreshStops();
                  }
              }, 10000);
          }
          
          function stopAutoRefresh() {
              if (autoRefreshTimer) {
                  clearInterval(autoRefreshTimer);
                  autoRefreshTimer = null;
              }
          }
      
          // ä½ç½®è·å–å’Œåˆå§‹æ¸²æŸ“
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(pos => {
                  userPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                  renderAllSections();
                  hasDataDisplayed = true;
                  startAutoRefresh();
              }, () => {
                  renderAllSections();
                  hasDataDisplayed = true;
                  startAutoRefresh();
              });
          } else {
              renderAllSections();
              hasDataDisplayed = true;
              startAutoRefresh();
          }
      
          // æœç´¢åŠŸèƒ½
          async function performSearch(val) {
              searchSection.innerHTML = '<h3><i class="fas fa-search"></i> æœç´¢ç»“æœ</h3>';
              
              const valLower = val.toLowerCase(); 
              const busStopMatches = busStops.filter(bs => 
                  bs.BusStopCode.includes(val) || 
                  bs.Description.toLowerCase().includes(valLower)
              );
              const busMatches = busServices.filter(svc => 
                  svc.ServiceNo.toLowerCase().includes(valLower)
              );
              
              let html = '';
              
              if (busMatches.length) {
                  const uniqueBusNos = [...new Set(busMatches.map(b => b.ServiceNo))];
                  uniqueBusNos.forEach(busNo => {
                      html += `<div class="busstop-card" data-bus="${busNo}">
                          <i class="fas fa-bus icon-lg"></i><span class="text-bold-lg"> ${busNo}</span>
                      </div>`;
                  });
              }
      
              if (busStopMatches.length) {
                  busStopMatches.forEach(s => {
                      let distanceText = '';
                      if (userPosition) {
                          const distance = haversine(userPosition.lat, userPosition.lng, s.Latitude, s.Longitude);
                          distanceText = ` &nbsp;<i class="fas fa-location-arrow icon-sm"></i> <span>${Math.round(distance)}m</span>`;
                      }
                      
                      html += `
                          <div class="busstop-card" data-stop="${s.BusStopCode}">
                              <div class="busstop-header">
                                  <h3>
                                      <i class="fas fa-directions icon-lg"></i> 
                                      <span class="busstop-name">${s.Description}</span>
                                  </h3>
                                  <p class="busstop-info">
                                      <i class="fas fa-minus-circle icon-sm"></i> 
                                      <span>${s.BusStopCode}</span>
                                      ${distanceText}
                                      &nbsp;<i class="fas fa-map-marked-alt icon-sm"></i> 
                                      <span>${s.RoadName}</span>
                                  </p>
                              </div>
                          </div>`;
                  });
              }
      
              if (!html) {
                  html = '<div class="busstop-card"><p><i class="fas fa-exclamation-circle"></i> æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</p></div>';
              }
      
              searchSection.innerHTML += html;
              currentView = 'search';
          }
      
          // æœç´¢è¾“å…¥å¤„ç†
          searchInput.addEventListener('input', async function () {
              const val = this.value.trim();
      
              if (!val) {
                  currentView = 'default';
                  showDefaultView();
                  renderAllSections();
                  expandedStopCode = null;
                  startAutoRefresh();
              } else {
                  currentView = 'search';
                  showSearchView();
                  stopAutoRefresh();
                  await performSearch(val);
                  startAutoRefresh();  
              }
          });
      
          // æœç´¢ç»“æœç‚¹å‡»äº‹ä»¶
          searchSection.addEventListener('click', async (e) => {
              const el = e.target.closest('.busstop-card');
              if (!el) return;
      
              if (el.dataset.bus) {
                  expandedStopCode = null;
                  const svc = el.dataset.bus;
                  const routes = busRoutes.filter(r => r.ServiceNo === svc);
                  await renderSearchBuses(svc, routes);
              } else if (el.dataset.stop) {
                  expandedStopCode = el.dataset.stop;
                  const bs = busStops.find(b => b.BusStopCode === el.dataset.stop);
                  if (bs) {
                      await renderSearchResults([bs]);
                  }
              }
          });
      
          // è·¯çº¿å›¾ç«™ç‚¹ç‚¹å‡»äº‹ä»¶
          document.addEventListener('click', async (e) => {
              const routeStop = e.target.closest('.route-stop-clickable');
              if (!routeStop) return;
              
              const stopCode = routeStop.dataset.stop;
              const bs = busStops.find(b => b.BusStopCode === stopCode);
              
              if (bs) {
                  document.getElementById('busModal').style.display = 'none';
                  currentView = 'search';
                  showSearchView();
                  searchInput.value = stopCode;
                  await renderSearchResults([bs]);
              }
          });
      
          // å·´å£«ç«™æ—¶é—´åˆ·æ–°å‡½æ•°
          async function refreshBusStopTimes(stopCode) {
              const bs = busStops.find(b => b.BusStopCode === stopCode);
              if (!bs) return;
              await renderSearchResults([bs]);
          }
      
          // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
          startAutoRefresh();
      })();
    </script>
  </body>
</html>