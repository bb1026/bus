<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>公交站测试</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; }
.bus-item { padding:10px; margin:5px; background:#f0f0f0; border-radius:5px; }
.error { color: red; }
.success { color: green; }
</style>
</head>
<body>

<h2>巴士站 API 测试</h2>
<div id="results"></div>

<script>
async function testAPIs() {
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '<p>开始测试...</p>';
  
  const testCases = [
    {
      name: "直接API调用",
      url: "https://busapi.0515364.xyz/busarrival?BusStopCode=59241"
    },
    {
      name: "使用CORS代理",
      url: "https://cors-anywhere.herokuapp.com/https://busapi.0515364.xyz/busarrival?BusStopCode=59241"
    },
    {
      name: "JSONP方式测试",
      url: "https://busapi.0515364.xyz/busarrival?BusStopCode=59241&callback=testCallback"
    }
  ];
  
  for (const testCase of testCases) {
    try {
      resultsDiv.innerHTML += `<p>测试: ${testCase.name}...</p>`;
      
      if (testCase.name === "JSONP方式测试") {
        // JSONP测试
        window.testCallback = function(data) {
          resultsDiv.innerHTML += `<p class="success">${testCase.name}: JSONP成功</p>`;
          console.log('JSONP数据:', data);
        };
        
        const script = document.createElement('script');
        script.src = testCase.url;
        document.head.appendChild(script);
        
        // 设置超时
        setTimeout(() => {
          if (!script.parentNode) return;
          script.parentNode.removeChild(script);
          resultsDiv.innerHTML += `<p class="error">${testCase.name}: JSONP超时</p>`;
        }, 5000);
        
      } else {
        // 普通fetch测试
        const response = await fetch(testCase.url, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json',
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          resultsDiv.innerHTML += `<p class="success">${testCase.name}: 成功 - 状态 ${response.status}</p>`;
          console.log(`${testCase.name}数据:`, data);
        } else {
          resultsDiv.innerHTML += `<p class="error">${testCase.name}: 失败 - 状态 ${response.status}</p>`;
        }
      }
      
    } catch (error) {
      resultsDiv.innerHTML += `<p class="error">${testCase.name}: 错误 - ${error.message}</p>`;
      console.error(`${testCase.name}错误:`, error);
    }
  }
}

// 测试网络连通性
async function testConnectivity() {
  const resultsDiv = document.getElementById('results');
  
  // 测试基本网络
  try {
    await fetch('https://httpbin.org/get');
    resultsDiv.innerHTML += '<p class="success">网络连接正常</p>';
  } catch (error) {
    resultsDiv.innerHTML += '<p class="error">网络连接失败</p>';
  }
  
  // 测试域名解析
  try {
    await fetch('https://busapi.0515364.xyz/', { mode: 'no-cors' });
    resultsDiv.innerHTML += '<p class="success">域名解析正常</p>';
  } catch (error) {
    resultsDiv.innerHTML += '<p class="error">域名解析失败</p>';
  }
}

// 运行测试
async function runAllTests() {
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '<h3>运行测试...</h3>';
  
  await testConnectivity();
  await testAPIs();
}

runAllTests();
</script>

</body>
</html>